<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Motor BLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Estilo para los botones cuando están desactivados */
        .btn-disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-sm mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 text-center">
        
        <header class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Control de Motor</h1>
            <p id="status" class="text-sm text-gray-500 mt-2">Desconectado</p>
        </header>

        <main>
            <button id="connectButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out">
                Conectar al ESP32
            </button>

            <div id="controls" class="mt-6 space-y-4 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <button id="forwardButton" class="bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center space-x-2 transition duration-300 ease-in-out">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                        <span>Horario</span>
                    </button>
                    <button id="reverseButton" class="bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center space-x-2 transition duration-300 ease-in-out">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                        <span>Antihorario</span>
                    </button>
                </div>
                <button id="stopButton" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 flex items-center justify-center space-x-2 transition duration-300 ease-in-out btn-disabled" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>
                    <span>Paro</span>
                </button>
            </div>
        </main>

    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const controlsDiv = document.getElementById('controls');
        const forwardButton = document.getElementById('forwardButton');
        const reverseButton = document.getElementById('reverseButton');
        const stopButton = document.getElementById('stopButton');
        const statusDisplay = document.getElementById('status');

        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let bleCharacteristic = null;
        let motorState = 'stopped'; // 'stopped', 'forward', 'reverse'

        const updateButtonState = () => {
            if (motorState === 'stopped') {
                forwardButton.disabled = false;
                forwardButton.classList.remove('btn-disabled');
                reverseButton.disabled = false;
                reverseButton.classList.remove('btn-disabled');
                stopButton.disabled = true;
                stopButton.classList.add('btn-disabled');
            } else {
                forwardButton.disabled = true;
                forwardButton.classList.add('btn-disabled');
                reverseButton.disabled = true;
                reverseButton.classList.add('btn-disabled');
                stopButton.disabled = false;
                stopButton.classList.remove('btn-disabled');
            }
        };
        
        connectButton.addEventListener('click', async () => {
            try {
                updateStatus('Buscando el ESP32...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Control Motor ESP32' }],
                    optionalServices: [SERVICE_UUID]
                });
                updateStatus('Conectando...');
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                updateStatus(`Conectado a ${device.name}`, 'success');
                connectButton.classList.add('hidden');
                controlsDiv.classList.remove('hidden');
                device.addEventListener('gattserverdisconnected', onDisconnected);
                updateButtonState();
            } catch (error) {
                console.error('Error en la conexión BLE:', error);
                if (error.name === 'NotFoundError') {
                    updateStatus('No se encontró el ESP32. Asegúrate de que está encendido y cerca.', 'error');
                } else {
                    updateStatus(`Error: ${error.message}`, 'error');
                }
            }
        });

        forwardButton.addEventListener('click', () => {
            motorState = 'forward';
            sendCommand('1');
            updateButtonState();
        });

        reverseButton.addEventListener('click', () => {
            motorState = 'reverse';
            sendCommand('2');
            updateButtonState();
        });

        stopButton.addEventListener('click', () => {
            motorState = 'stopped';
            sendCommand('0');
            updateButtonState();
        });

        function sendCommand(command) {
            if (!bleCharacteristic) {
                updateStatus('No hay conexión', 'error');
                return;
            }
            const encoder = new TextEncoder();
            bleCharacteristic.writeValue(encoder.encode(command))
                .catch(error => {
                    console.error('Error al enviar comando:', error);
                    updateStatus(`Error al enviar: ${error.message}`, 'error');
                });
        }
        
        function onDisconnected() {
            updateStatus('Dispositivo desconectado', 'error');
            bleCharacteristic = null;
            motorState = 'stopped';
            connectButton.classList.remove('hidden');
            controlsDiv.classList.add('hidden');
        }

        function updateStatus(message, type = 'info') {
            statusDisplay.textContent = message;
            statusDisplay.className = 'text-sm mt-2';
            if (type === 'success') statusDisplay.classList.add('text-green-600');
            else if (type === 'error') statusDisplay.classList.add('text-red-600');
            else statusDisplay.classList.add('text-gray-500');
        }
    </script>
</body>
</html>
