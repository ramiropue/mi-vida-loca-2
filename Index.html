<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Motor BLE</title>
    <!-- Usamos Tailwind CSS para un diseño limpio y rápido -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Evita el flash azul al tocar botones en móviles */
        }
        /* Estilo para los botones cuando están desactivados */
        .btn-disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-sm mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 text-center">
        
        <header class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Control de Motor</h1>
            <p id="status" class="text-sm text-gray-500 mt-2">Desconectado</p>
        </header>

        <main>
            <!-- Botón de Conexión -->
            <button id="connectButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out">
                Conectar al ESP32
            </button>

            <!-- Controles del Motor -->
            <div id="controls" class="mt-6 grid grid-cols-2 gap-4 hidden">
                <button id="startButton" class="bg-green-500 text-white font-bold py-4 px-4 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-50 transition duration-300 ease-in-out flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Marcha</span>
                </button>
                <button id="stopButton" class="bg-red-500 text-white font-bold py-4 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50 transition duration-300 ease-in-out flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Paro</span>
                </button>
            </div>
        </main>

    </div>

    <script>
        // Referencias a los elementos del DOM
        const connectButton = document.getElementById('connectButton');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusDisplay = document.getElementById('status');
        const controlsDiv = document.getElementById('controls');

        // UUIDs que deben coincidir exactamente con los del código del ESP32
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let bleCharacteristic = null; // Variable para guardar la característica BLE

        // --- LÓGICA DE LA APLICACIÓN ---

        // Evento para el botón de conectar
        connectButton.addEventListener('click', async () => {
            try {
                updateStatus('Buscando dispositivo...');
                
                // 1. Solicitar al navegador que busque dispositivos BLE
                // ---- CAMBIO PARA DIAGNÓSTICO ----
                // Ahora aceptamos cualquier dispositivo para ver si el nuestro aparece en la lista.
                // Seguiremos pidiendo acceso al servicio que nos interesa con 'optionalServices'.
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('Conectando al dispositivo...');
                
                // 2. Conectar al servidor GATT del dispositivo
                const server = await device.gatt.connect();

                // 3. Obtener el servicio BLE
                const service = await server.getPrimaryService(SERVICE_UUID);

                // 4. Obtener la característica BLE
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                // Si todo ha ido bien, actualizamos la interfaz
                updateStatus(`Conectado a ${device.name}`, 'success');
                connectButton.classList.add('hidden'); // Ocultar botón de conectar
                controlsDiv.classList.remove('hidden'); // Mostrar controles

                // Escuchar por si el dispositivo se desconecta
                device.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                console.error('Error en la conexión BLE:', error);
                // El error 'User cancelled' es normal si el usuario cierra la ventana de selección.
                if (error.name !== 'NotFoundError') {
                    updateStatus(`Error: ${error.message}`, 'error');
                } else {
                    updateStatus('Búsqueda cancelada.', 'info');
                }
            }
        });

        // Evento para el botón de INICIAR
        startButton.addEventListener('click', () => {
            sendCommand('1');
            updateStatus('Motor en marcha', 'success');
        });

        // Evento para el botón de PARAR
        stopButton.addEventListener('click', () => {
            sendCommand('0');
            updateStatus('Motor parado', 'success');
        });

        // Función para enviar un comando a la característica BLE
        function sendCommand(command) {
            if (!bleCharacteristic) {
                updateStatus('No hay conexión', 'error');
                return;
            }
            // Los datos se deben enviar como un Array de bytes (Uint8Array)
            const encoder = new TextEncoder();
            bleCharacteristic.writeValue(encoder.encode(command))
                .catch(error => {
                    console.error('Error al enviar comando:', error);
                    updateStatus(`Error al enviar: ${error.message}`, 'error');
                });
        }
        
        // Función que se ejecuta cuando el dispositivo se desconecta
        function onDisconnected() {
            updateStatus('Dispositivo desconectado', 'error');
            bleCharacteristic = null;
            connectButton.classList.remove('hidden');
            controlsDiv.classList.add('hidden');
        }

        // Función para actualizar el texto de estado y su color
        function updateStatus(message, type = 'info') {
            statusDisplay.textContent = message;
            statusDisplay.classList.remove('text-gray-500', 'text-green-600', 'text-red-600');
            if (type === 'success') {
                statusDisplay.classList.add('text-green-600');
            } else if (type === 'error') {
                statusDisplay.classList.add('text-red-600');
            } else {
                statusDisplay.classList.add('text-gray-500');
            }
        }
    </script>
</body>
</html>
```

### Pasos a Seguir:

1.  Abre esta nueva versión de la WebApp en tu móvil.
2.  Pulsa "Conectar al ESP32".
3.  Ahora debería aparecer una lista con **todos** los dispositivos Bluetooth LE cercanos (auriculares, smartwatches, etc.).
4.  Busca en esa lista el nombre de tu placa: **"Control Motor ESP32"**.

Por favor, dime cuál de los dos resultados obtienes. Esto nos dará la pista definiti
