/*
  Código Completo para Control de Dos Motores con Control Maestro
  
  VERSIÓN CORREGIDA PARA RELÉS "ACTIVE-LOW" (Lógica Invertida)
  - Se envía LOW para ENCENDER el relé.
  - Se envía HIGH para APAGAR el relé.
  - El cableado físico debe estar en los terminales NO (Normalmente Abierto) por seguridad.
*/

#include <ArduinoBLE.h>

// --- Definición de estados para la lógica invertida ---
#define RELAY_ON  LOW
#define RELAY_OFF HIGH

// --- CONFIGURACIÓN DE PINES ---
const int relayM1_Forward = 12;
const int relayM1_Reverse = 13;
const int relayM2_Forward = 27;
const int relayM2_Reverse = 26;

// --- CONFIGURACIÓN BLE ---
#define SERVICE_UUID        "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHARACTERISTIC_UUID "beb5483e-36e1-4688-b7f5-ea07361b26a8"

BLEService motorService(SERVICE_UUID);
BLEStringCharacteristic controlCharacteristic(CHARACTERISTIC_UUID, BLERead | BLEWrite, 7);
bool serviceAdded = false;

// --- FUNCIÓN CALLBACK ---
void onCommandWritten(BLEDevice central, BLECharacteristic characteristic) {
  String command = controlCharacteristic.value();
  command.trim();
  Serial.print("Comando recibido: ");
  Serial.println(command);

  String target = command.substring(0, command.indexOf(':'));
  String action = command.substring(command.indexOf(':') + 1);

  if (target == "M1") {
    if (action == "1") { digitalWrite(relayM1_Reverse, RELAY_OFF); digitalWrite(relayM1_Forward, RELAY_ON); }
    else if (action == "2") { digitalWrite(relayM1_Forward, RELAY_OFF); digitalWrite(relayM1_Reverse, RELAY_ON); }
    else if (action == "0") { digitalWrite(relayM1_Forward, RELAY_OFF); digitalWrite(relayM1_Reverse, RELAY_OFF); }
  } else if (target == "M2") {
    if (action == "1") { digitalWrite(relayM2_Reverse, RELAY_OFF); digitalWrite(relayM2_Forward, RELAY_ON); }
    else if (action == "2") { digitalWrite(relayM2_Forward, RELAY_OFF); digitalWrite(relayM2_Reverse, RELAY_ON); }
    else if (action == "0") { digitalWrite(relayM2_Forward, RELAY_OFF); digitalWrite(relayM2_Reverse, RELAY_OFF); }
  } else if (target == "M_ALL") {
    if (action == "1") { // Encender ambos en horario
      digitalWrite(relayM1_Reverse, RELAY_OFF);
      digitalWrite(relayM2_Reverse, RELAY_OFF);
      digitalWrite(relayM1_Forward, RELAY_ON);
      digitalWrite(relayM2_Forward, RELAY_ON);
    } else if (action == "0") { // Parar ambos
      digitalWrite(relayM1_Forward, RELAY_OFF);
      digitalWrite(relayM1_Reverse, RELAY_OFF);
      digitalWrite(relayM2_Forward, RELAY_OFF);
      digitalWrite(relayM2_Reverse, RELAY_OFF);
    }
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("--- Iniciando Control Dual (Lógica Invertida) ---");

  pinMode(relayM1_Forward, OUTPUT); pinMode(relayM1_Reverse, OUTPUT);
  pinMode(relayM2_Forward, OUTPUT); pinMode(relayM2_Reverse, OUTPUT);
  // Estado inicial de seguridad: todos los relés apagados (señal HIGH)
  digitalWrite(relayM1_Forward, RELAY_OFF);
  digitalWrite(relayM1_Reverse, RELAY_OFF);
  digitalWrite(relayM2_Forward, RELAY_OFF);
  digitalWrite(relayM2_Reverse, RELAY_OFF);

  if (!BLE.begin()) {
    Serial.println("FALLO CRÍTICO: No se pudo iniciar el módulo BLE.");
    while (1);
  }

  BLE.setLocalName("mi vida loca");
  BLE.advertise();
  Serial.println("Éxito: Anuncio simple iniciado.");
  Serial.println("------------------------------------------------");
}

void loop() {
  BLEDevice central = BLE.central();
  if (central) {
    Serial.print("Dispositivo conectado: ");
    Serial.println(central.address());
    delay(200);
    if (!serviceAdded) {
      Serial.println("Activando servicios...");
      BLE.stopAdvertise();
      motorService.addCharacteristic(controlCharacteristic);
      BLE.addService(motorService);
      controlCharacteristic.setEventHandler(BLEWritten, onCommandWritten);
      serviceAdded = true;
      BLE.advertise();
      Serial.println("Servicios activados.");
    }
    while (central.connected()) {
      BLE.poll();
    }
    Serial.print("Dispositivo desconectado: ");
    Serial.println(central.address());
    serviceAdded = false;
  }
}
