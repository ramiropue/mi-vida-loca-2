<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Motor</title>
    <!-- Incluimos Tailwind CSS para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Pequeños ajustes para una mejor experiencia */
        body {
            -webkit-tap-highlight-color: transparent; /* Evita el destello azul en los botones en móviles */
        }
        /* Estilo para los botones cuando están deshabilitados */
        .btn:disabled {
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm bg-gray-800 rounded-2xl shadow-lg p-6 space-y-6">
        
        <div class="text-center">
            <h1 class="text-2xl font-bold text-cyan-400">Control de Motor</h1>
            <p id="status" class="text-gray-400 mt-2">Desconectado. Pulsa para conectar.</p>
        </div>

        <!-- Botón de Conexión -->
        <button id="connect-btn" class="btn w-full bg-cyan-500 hover:bg-cyan-600 active:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95">
            Conectar a ESP32
        </button>

        <!-- Panel de Control del Motor -->
        <div class="grid grid-cols-2 gap-4 pt-4">
            <button id="left-btn" class="btn w-full bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-transform transform active:scale-95 disabled:opacity-50" disabled>
                &#8592; Izquierda
            </button>
            <button id="right-btn" class="btn w-full bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-transform transform active:scale-95 disabled:opacity-50" disabled>
                Derecha &#8594;
            </button>
        </div>
        
        <button id="stop-btn" class="btn w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold py-4 px-4 rounded-lg transition-transform transform active:scale-95 disabled:opacity-50" disabled>
            &#9632; PARAR
        </button>

    </div>

    <script>
        // --- Referencias a los elementos del DOM ---
        const connectButton = document.getElementById('connect-btn');
        const stopButton = document.getElementById('stop-btn');
        const leftButton = document.getElementById('left-btn');
        const rightButton = document.getElementById('right-btn');
        const statusDisplay = document.getElementById('status');

        // --- Variables Globales de Web Bluetooth ---
        let bluetoothDevice;
        let motorCharacteristic;

        // UUID del servicio de puerto serie estándar de Bluetooth
        const UART_SERVICE_UUID = "00001101-0000-1000-8000-00805f9b34fb";
        // El UUID de la característica puede variar, pero este es el estándar para TX/RX
        const UART_CHARACTERISTIC_UUID = "00001101-0000-1000-8000-00805f9b34fb";


        // --- Lógica de la Interfaz de Usuario ---
        function updateUIForState(state) {
            switch(state) {
                case 'CONNECTED_STOPPED':
                    statusDisplay.textContent = 'Conectado: Motor Parado';
                    statusDisplay.classList.remove('text-green-400', 'text-red-400');
                    statusDisplay.classList.add('text-yellow-400');
                    leftButton.disabled = false;
                    rightButton.disabled = false;
                    stopButton.disabled = true;
                    connectButton.disabled = true;
                    connectButton.textContent = 'Conectado';
                    connectButton.classList.add('opacity-50', 'cursor-not-allowed');
                    break;
                case 'CONNECTED_MOVING':
                    statusDisplay.textContent = 'Conectado: Motor en Marcha';
                    statusDisplay.classList.remove('text-yellow-400', 'text-red-400');
                    statusDisplay.classList.add('text-green-400');
                    leftButton.disabled = true;
                    rightButton.disabled = true;
                    stopButton.disabled = false;
                    break;
                case 'DISCONNECTED':
                    statusDisplay.textContent = 'Desconectado. Pulsa para conectar.';
                    statusDisplay.classList.remove('text-green-400', 'text-yellow-400');
                    statusDisplay.classList.add('text-red-400');
                    leftButton.disabled = true;
                    rightButton.disabled = true;
                    stopButton.disabled = true;
                    connectButton.disabled = false;
                    connectButton.textContent = 'Conectar a ESP32';
                    connectButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    break;
            }
        }

        // --- Función para enviar comandos ---
        async function sendCommand(command) {
            if (!motorCharacteristic) {
                console.error('Característica no disponible.');
                return;
            }
            try {
                // Los comandos se envían como un array de bytes.
                const data = new TextEncoder().encode(command);
                await motorCharacteristic.writeValue(data);
                console.log(`Comando enviado: ${command}`);
            } catch (error) {
                console.error('Error al enviar comando:', error);
                alert(`Error al enviar el comando: ${error.message}`);
            }
        }

        // --- Lógica de Conexión Bluetooth ---
        connectButton.addEventListener('click', async () => {
            try {
                statusDisplay.textContent = 'Buscando dispositivos...';
                
                // Solicita al usuario que elija un dispositivo Bluetooth
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'MotorControlESP32' }], // Filtra por el nombre que pusimos en el ESP32
                    optionalServices: [UART_SERVICE_UUID]
                });

                statusDisplay.textContent = 'Conectando al dispositivo...';
                
                // Conectar al servidor GATT del dispositivo
                const server = await bluetoothDevice.gatt.connect();

                // Obtener el servicio UART
                const service = await server.getPrimaryService(UART_SERVICE_UUID);

                // Obtener la característica para escribir datos
                motorCharacteristic = await service.getCharacteristic(UART_CHARACTERISTIC_UUID);

                console.log('¡Conexión exitosa!');
                updateUIForState('CONNECTED_STOPPED');
                
                // Escuchar eventos de desconexión
                bluetoothDevice.addEventListener('gattserverdisconnected', () => {
                    console.log('Dispositivo desconectado.');
                    motorCharacteristic = null;
                    bluetoothDevice = null;
                    updateUIForState('DISCONNECTED');
                });

            } catch (error) {
                console.error('Error en la conexión Bluetooth:', error);
                statusDisplay.textContent = `Error: ${error.message}`;
                updateUIForState('DISCONNECTED');
            }
        });

        // --- Event Listeners para los botones de control ---
        leftButton.addEventListener('click', () => {
            sendCommand('L');
            updateUIForState('CONNECTED_MOVING');
        });

        rightButton.addEventListener('click', () => {
            sendCommand('R');
            updateUIForState('CONNECTED_MOVING');
        });

        stopButton.addEventListener('click', () => {
            sendCommand('S');
            updateUIForState('CONNECTED_STOPPED');
        });
        
        // Estado inicial de la UI
        updateUIForState('DISCONNECTED');
    </script>
</body>
</html>
