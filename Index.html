<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Dual de Motores</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 1rem; background-color: #f0f2f5; }
        h1 { margin-bottom: 0.5rem; color: #333; }
        #status-container { width: 100%; max-width: 800px; text-align: center; margin-bottom: 1rem; }
        #status { font-size: 1.2rem; font-weight: bold; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.3s; display: inline-block; }
        .disconnected { color: #d32f2f; background-color: #ffebee; }
        .connecting { color: #f57c00; background-color: #fff3e0; }
        .connected { color: #388e3c; background-color: #e8f5e9; }

        #motors-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; width: 100%; }
        .motor-panel { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px_20px rgba(0,0,0,0.1); text-align: center; min-width: 300px; }
        .motor-panel h2 { margin-top: 0; }
        
        .motor-indicator { font-size: 5rem; margin: 1rem 0; transition: color 0.4s ease; }
        .motor-stopped { color: #9e9e9e; transform: rotate(0deg); }
        .motor-forward { color: #43a047; animation: rotate-forward 2s linear infinite; }
        .motor-reverse { color: #2196F3; animation: rotate-reverse 2s linear infinite; }
        
        @keyframes rotate-forward { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotate-reverse { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }

        .controls { display: flex; justify-content: center; }
        .btn { font-size: 1rem; padding: 0.8rem 1rem; margin: 0.3rem; border: none; border-radius: 8px; cursor: pointer; color: white; transition: background-color 0.3s, transform 0.1s; min-width: 90px; }
        .btn:active { transform: scale(0.98); }
        #btn-connect { background-color: #1976d2; width: 100%; max-width: 300px; margin-top: 1rem; font-size: 1.2rem; padding: 1rem; }
        
        .btn-forward { background-color: #43a047; }
        .btn-stop { background-color: #e53935; }
        .btn-back { background-color: #2196F3; }
    </style>
</head>
<body>

    <h1>Control Dual de Motores</h1>
    <div id="status-container">
        <div id="status" class="disconnected">Desconectado</div>
    </div>

    <div id="motors-container" style="display: none;">
        <div class="motor-panel">
            <h2>Motor 1</h2>
            <div id="motor-1-indicator" class="motor-indicator motor-stopped">⚙️</div>
            <div class="controls">
                <button class="btn btn-forward" data-command="1">Adelante</button>
                <button class="btn btn-stop" data-command="0">Detener</button>
                <button class="btn btn-back" data-command="2">Atrás</button>
            </div>
        </div>

        <div class="motor-panel">
            <h2>Motor 2</h2>
            <div id="motor-2-indicator" class="motor-indicator motor-stopped">⚙️</div>
            <div class="controls">
                <button class="btn btn-forward" data-command="11">Adelante</button>
                <button class="btn btn-stop" data-command="10">Detener</button>
                <button class="btn btn-back" data-command="12">Atrás</button>
            </div>
        </div>
    </div>

    <button id="btn-connect" class="btn">Conectar por Bluetooth</button>
    
    <script>
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let bleCharacteristic;

        const statusDiv = document.getElementById('status');
        const btnConnect = document.getElementById('btn-connect');
        const motorsContainer = document.getElementById('motors-container');
        const motor1Indicator = document.getElementById('motor-1-indicator');
        const motor2Indicator = document.getElementById('motor-2-indicator');

        btnConnect.addEventListener('click', async () => {
            try {
                updateStatus('Buscando ESP32...', 'connecting');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ControlMotorESP32-Dual' }],
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('Conectando...', 'connecting');
                device.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                updateStatus('Conectado ✓', 'connected');
                btnConnect.style.display = 'none';
                motorsContainer.style.display = 'flex';
                updateMotorIndicator(1, 0);
                updateMotorIndicator(2, 0);

            } catch (error) {
                console.error('Error:', error);
                updateStatus(`Error: ${error.message}`, 'disconnected');
            }
        });

        function onDisconnected() {
            updateStatus('Desconectado', 'disconnected');
            bleCharacteristic = null;
            btnConnect.style.display = 'block';
            motorsContainer.style.display = 'none';
        }
        
        // Asignar eventos a todos los botones de control
        document.querySelectorAll('.btn[data-command]').forEach(button => {
            button.addEventListener('click', () => {
                const command = parseInt(button.dataset.command);
                sendCommand(command);
            });
        });

        async function sendCommand(command) {
            if (!bleCharacteristic) return alert('No hay conexión.');
            
            const motorNumber = command < 10 ? 1 : 2;
            const state = command % 10;
            updateMotorIndicator(motorNumber, state);

            try {
                await bleCharacteristic.writeValue(Uint8Array.of(command));
            } catch (error) {
                console.error('Error al enviar comando:', error);
                // Revertir el indicador si falla el envío
                updateMotorIndicator(motorNumber, 0);
            }
        }
        
        function updateMotorIndicator(motorNumber, state) {
            const indicator = (motorNumber === 1) ? motor1Indicator : motor2Indicator;
            indicator.className = 'motor-indicator'; // Reset classes
            switch (state) {
                case 0: indicator.classList.add('motor-stopped'); break;
                case 1: indicator.classList.add('motor-forward'); break;
                case 2: indicator.classList.add('motor-reverse'); break;
            }
        }

        function updateStatus(message, statusClass) {
            statusDiv.textContent = message;
            statusDiv.className = statusClass;
        }
    </script>
</body>
</html>
