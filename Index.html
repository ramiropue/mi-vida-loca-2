<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Motor ESP32</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { text-align: center; background: white; padding: 2rem 3rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 0.5rem; }
        #status { font-size: 1.2rem; font-weight: bold; margin-bottom: 1.5rem; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.3s; }
        .disconnected { color: #d32f2f; background-color: #ffebee; }
        .connecting { color: #f57c00; background-color: #fff3e0; }
        .connected { color: #388e3c; background-color: #e8f5e9; }
        .btn { font-size: 1.2rem; padding: 1rem 2rem; margin: 0.5rem; border: none; border-radius: 8px; cursor: pointer; color: white; transition: background-color 0.3s, transform 0.1s; min-width: 220px; }
        .btn:active { transform: scale(0.98); }
        #btn-connect { background-color: #1976d2; }
        #btn-connect:hover { background-color: #1565c0; }
        .btn-control { background-color: #555; }
        .btn-control:disabled { background-color: #9e9e9e; cursor: not-allowed; }
        #btn-forward { background-color: #43a047; }
        #btn-reverse { background-color: #e53935; }
        #btn-stop { background-color: #fdd835; color: #333; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Control del Motor ⚙️</h1>
        <div id="status" class="disconnected">Desconectado</div>

        <button id="btn-connect" class="btn">Conectar por Bluetooth</button>
        
        <div id="controls" style="display: none;">
            <button id="btn-forward" class="btn btn-control">Adelante</button>
            <button id="btn-reverse" class="btn btn-control">Reversa</button>
            <button id="btn-stop" class="btn btn-control">Detener</button>
        </div>
    </div>

    <script>
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let bleDevice;
        let bleCharacteristic;

        const statusDiv = document.getElementById('status');
        const btnConnect = document.getElementById('btn-connect');
        const controlsDiv = document.getElementById('controls');
        
        const btnForward = document.getElementById('btn-forward');
        const btnReverse = document.getElementById('btn-reverse');
        const btnStop = document.getElementById('btn-stop');

        btnConnect.addEventListener('click', async () => {
            try {
                updateStatus('Buscando ESP32...', 'connecting');
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ControlMotorESP32' }],
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('Conectando...', 'connecting');
                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                updateStatus('Conectado ✓', 'connected');
                btnConnect.style.display = 'none';
                controlsDiv.style.display = 'block';

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                console.error('Error de conexión:', error);
                updateStatus(`Error: ${error.message}`, 'disconnected');
            }
        });

        function onDisconnected() {
            updateStatus('Desconectado', 'disconnected');
            btnConnect.style.display = 'block';
            controlsDiv.style.display = 'none';
            bleDevice = null;
            bleCharacteristic = null;
        }

        async function sendCommand(command) {
            if (!bleCharacteristic) {
                alert('No hay conexión con el dispositivo.');
                return;
            }
            try {
                const value = Uint8Array.of(command);
                await bleCharacteristic.writeValue(value);
                console.log(`Comando enviado: ${command}`);
            } catch (error) {
                console.error('Error al enviar comando:', error);
                alert(`Error: ${error.message}`);
            }
        }

        btnForward.addEventListener('click', () => sendCommand(1));
        btnReverse.addEventListener('click', () => sendCommand(2));
        btnStop.addEventListener('click', () => sendCommand(0));

        function updateStatus(message, statusClass) {
            statusDiv.textContent = message;
            statusDiv.className = statusClass;
        }
    </script>

</body>
</html>
