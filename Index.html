<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Dual de Motores BLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .btn-disabled { cursor: not-allowed; opacity: 0.5; background-color: #9ca3af !important; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-lg p-6 text-center">
        
        <header class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Control Dual de Motores</h1>
            <p id="status" class="text-sm text-gray-500 mt-2">Desconectado</p>
        </header>

        <main>
            <button id="connectButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out">
                Conectar al ESP32
            </button>

            <div id="controls" class="mt-6 space-y-6 hidden">
                <!-- Controles Motor 1 -->
                <div class="p-4 border rounded-lg">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Motor 1</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="forwardButton1" class="bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center space-x-2 transition"><span>Horario</span></button>
                        <button id="reverseButton1" class="bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center space-x-2 transition"><span>Antihorario</span></button>
                    </div>
                    <button id="stopButton1" class="mt-4 w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 flex items-center justify-center space-x-2 transition"><span>Paro</span></button>
                </div>

                <!-- Controles Motor 2 -->
                <div class="p-4 border rounded-lg">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Motor 2</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="forwardButton2" class="bg-sky-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-600 flex items-center justify-center space-x-2 transition"><span>Horario</span></button>
                        <button id="reverseButton2" class="bg-sky-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-600 flex items-center justify-center space-x-2 transition"><span>Antihorario</span></button>
                    </div>
                    <button id="stopButton2" class="mt-4 w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 flex items-center justify-center space-x-2 transition"><span>Paro</span></button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const controlsDiv = document.getElementById('controls');
        const statusDisplay = document.getElementById('status');

        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        let bleCharacteristic = null;

        const motors = {
            M1: {
                state: 'stopped',
                buttons: {
                    forward: document.getElementById('forwardButton1'),
                    reverse: document.getElementById('reverseButton1'),
                    stop: document.getElementById('stopButton1'),
                }
            },
            M2: {
                state: 'stopped',
                buttons: {
                    forward: document.getElementById('forwardButton2'),
                    reverse: document.getElementById('reverseButton2'),
                    stop: document.getElementById('stopButton2'),
                }
            }
        };

        const updateAllButtonStates = () => {
            for (const motorId in motors) {
                const motor = motors[motorId];
                const isStopped = motor.state === 'stopped';
                motor.buttons.forward.disabled = !isStopped;
                motor.buttons.reverse.disabled = !isStopped;
                motor.buttons.stop.disabled = isStopped;

                motor.buttons.forward.classList.toggle('btn-disabled', !isStopped);
                motor.buttons.reverse.classList.toggle('btn-disabled', !isStopped);
                motor.buttons.stop.classList.toggle('btn-disabled', isStopped);
            }
        };
        
        connectButton.addEventListener('click', async () => {
            try {
                updateStatus('Buscando el ESP32...');
                
                // --- CAMBIO PARA COMPATIBILIDAD CON iOS ---
                // Volvemos a buscar todos los dispositivos para asegurar que el navegador pueda ver el ESP32.
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('Conectando...');
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                updateStatus(`Conectado a ${device.name}`, 'success');
                connectButton.classList.add('hidden');
                controlsDiv.classList.remove('hidden');
                device.addEventListener('gattserverdisconnected', onDisconnected);
                updateAllButtonStates();
            } catch (error) {
                console.error('Error:', error);
                updateStatus(error.name === 'NotFoundError' ? 'No se encontró ningún dispositivo.' : `Error: ${error.message}`, 'error');
            }
        });

        Object.keys(motors).forEach(motorId => {
            const motor = motors[motorId];
            motor.buttons.forward.addEventListener('click', () => {
                motor.state = 'forward';
                sendCommand(`${motorId}:1`);
                updateAllButtonStates();
            });
            motor.buttons.reverse.addEventListener('click', () => {
                motor.state = 'reverse';
                sendCommand(`${motorId}:2`);
                updateAllButtonStates();
            });
            motor.buttons.stop.addEventListener('click', () => {
                motor.state = 'stopped';
                sendCommand(`${motorId}:0`);
                updateAllButtonStates();
            });
        });

        function sendCommand(command) {
            if (!bleCharacteristic) return;
            const encoder = new TextEncoder();
            bleCharacteristic.writeValue(encoder.encode(command)).catch(err => console.error('Error al enviar:', err));
        }
        
        function onDisconnected() {
            updateStatus('Dispositivo desconectado', 'error');
            bleCharacteristic = null;
            motors.M1.state = 'stopped';
            motors.M2.state = 'stopped';
            connectButton.classList.remove('hidden');
            controlsDiv.classList.add('hidden');
        }

        function updateStatus(message, type = 'info') {
            statusDisplay.textContent = message;
            statusDisplay.className = 'text-sm mt-2';
            if (type === 'success') statusDisplay.classList.add('text-green-600');
            else if (type === 'error') statusDisplay.classList.add('text-red-600');
            else statusDisplay.classList.add('text-gray-500');
        }
    </script>
</body>
</html>
```

### Pasos a seguir:

1.  Abre esta nueva versión de la WebApp en el navegador **Bluefy** de tu iPhone.
2.  Pulsa el botón "Conectar al ESP32".
3.  Ahora debería aparecer una lista con todos los dispositivos Bluetooth cercanos que tu móvil detecte.

Por favor, comprueba si en esa lista aparece tu dispositivo **"Control Dual Motor ESP32"**.

* **Si aparece:** ¡Perfecto! Simplemente selecciónalo y todo debería funcionar. Esto confirma que el problema es el filtro por nombre en iOS. Podemos dejar la app así para asegurar que siempre funcione.
* **Si sigue sin aparecer:** Esto sería muy raro, e indicaría un problema más profundo con el navegador Bluefy o la versión de iOS. En ese caso, podríamos probar con otro navegador compatible como "WebBLE".

Quedo a la espera de tu respuesta. ¡Verás como así lo solucionam
